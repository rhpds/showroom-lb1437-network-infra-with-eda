= Ansible Automation Platform

With everything built and working on the command line, let's move our workload into Ansible Automation Platform.

[#controller]
== Configuring Automation Controller

Back in Exercise 1.1 we had two links from the student assignment, one for VS Code and another for Automation Controller. Now we will click the Ansible Automation Platform link and login with the information listed under the link.

You are looking for something that looks like this:

image::5_controller.png[Controller]

(you own information will be different)

Once logged in, in the left side navigation, expand `Automation Execution` and click on `Templates`. Click on the blue `Create template` button and choose `Create job template`.

image::6_templates.png[Templates]

TIP: If you don't have a navigation bar as seen in the screenshot, it may be hidden due to limited screen space. You can click on the 3 lines in the upper left corner to access it.

Fill out the form with the information below:

[cols="1,1"]
|===
| *Name*
| Router configuration

| *Inventory*
| Workshop Inventory

| *Project*
| Cisco Telemetry

| *Playbook*
| playbooks/configure_ios_routing.yml

| *Credentials*
| Workshop Credential \| Machine

| *Execution environment*
| network workshop execution environment

| *Extra variables*
| Check `Prompt on launch` box
|===

When this information is entered, click the `Save job template` button.

At the top of the screen, click on the `Launch template` button.

image::7_launch.png[Launch]

You'll be prompted for variables (if not, double check your template has the right box checked). Don't enter anything and just click Next, then Finish.

After about a minute (you will be waiting for the Execution Environment image to pull since this is a new AAP environment), the playbook runs, and it should look just like the other times we ran this same playbook on the command line. It should still come back with all `ok` task outputs. The difference now is that we have access to enterprise features like role-based access control, automatic logging, push-button execution, and API-based job launches, among others.

[#eda]
== Configuring Event-Driven Ansible Controller

Now that we have the AAP equivalent of our `ansible-navigator` command on the command line, we need to work on building the AAP equivalent of the `ansible-rulebook` command we were running in Exercise 4.2.

In the left side navigation, expand Automation Decisions, and click on Rulebook Activations. You shouldn't have any activations yet, so click on the blue `Create rulebook activation` button.

Similar to what you did for the Job Template, fill out the form with the information below:

[cols="1,1"]
|===
| *Name*
| Interface status

| *Organization*
| Default

| *Project*
| Cisco Telemetry

| *Rulebook*
| interface_status_aap.yml

| *Credentials*
| Automation Controller

| *Decision environment*
| Quay DE
|===

Everything else can be left empty or default. Click the `Create rulebook activation` button.

Two things to highlight here:

* The rulebook `interface_status_aap.yml` is the same as the rulebook `interface_status_cli.yml` that you ran earlier on the command line with one key difference: The action is to kick off a Job Template (the one you just made). This is the reason why you need the `Automation Controller` credential.
* We are using a Decision Environment, which is like an Execution Environment, but for use with Event-Driven Ansible.

The Rulebook Activation will try to start. As before, with the new environment you'll need to wait for it to pull the Decision Environment image, but after about a minute you should see `Activation status` change to `Running`. At the top of the screen, click on the `History` tab, then click on the `1 - Interface status` link. Here is where we can see the ansible-rulebook log and verify that everything came up with no errors.

As before, we want to break the router config to see it get fixed. Switch back to your VSCode tab and ssh to rtr1 to do so. The commands again are:

[source,role=execute]
----
ssh rtr1
----

[source,role=execute]
----
configure terminal
interface Tunnel0
shutdown
----

Switch back to your AAP tab. In the left side navigation, under Automation Decisions, click on Rule Audit. Depending on how quick you were, you'll either already see an entry on this page, or one will appear shortly. Once available, click on `Re-apply config when interface not up` (which is the name of the rule in the rulebook).

On the page that appears, click on the `Events` tab. There should be one entry for ansible.eda.kafka. Click on it. The event details pop up, and we can see that we have the same data available to us as we did in Exercise 4.1. Click the `Close` button.

Click on the `Actions` tab. We can see a single entry `run_job_template`. Instead of clicking the link, in the left side navigation, click on *Automation Execution > Jobs*. You should see a second instance of "Router configuration" appear in the list with a very recent timestamp. Click on it to observe that the "Apply interfaces config" task reports `changed` just as it did before on the CLI.

image::10_intf-changed.png[intf-changed]

You now have AAP running the same Event-Driven workload as we developed on the command line.
